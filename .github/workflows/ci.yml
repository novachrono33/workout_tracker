name: Code Quality CI

on:
  push:
    branches: [ main, develop, feature/** ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  backend-lint:
    name: ğŸ Backend Linting
    runs-on: ubuntu-latest
    timeout-minutes: 5
    defaults:
      run:
        working-directory: ./backend

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: backend/requirements.txt
    
    - name: ğŸ“¦ Install backend dependencies
      run: |
        pip install black==23.12.1 flake8==6.1.0 isort==5.13.2 mypy==1.8.0 bandit==1.7.7 safety>=3.0.0
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi
    
    - name: ğŸ§¹ Check imports (isort)
      run: isort --check-only --diff app/ || echo "âš ï¸  Import sorting issues found"
    
    - name: ğŸ¨ Check formatting (black)
      run: black --check --diff app/ || echo "âš ï¸  Formatting issues found"
    
    - name: ğŸ” Lint with flake8
      run: flake8 app/ --count --statistics || echo "âš ï¸  Style issues found"
    
    - name: ğŸ“ Type checking (mypy)
      run: mypy app/ --no-error-summary || echo "âš ï¸  Type issues found"
    
    - name: ğŸ”’ Security check (bandit)
      run: bandit -r app/ -f json -o bandit-report.json || echo "âš ï¸  Security issues found"
    
    - name: ğŸ” Dependency security (safety)
      if: hashFiles('backend/requirements.txt') != ''
      run: safety check -r requirements.txt --json > safety-report.json || echo "âš ï¸  Dependency vulnerabilities found"

  frontend-lint:
    name: âš›ï¸ Frontend Linting
    runs-on: ubuntu-latest
    timeout-minutes: 5
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: ğŸ“¦ Install frontend dependencies
      run: npm ci
    
    - name: ğŸ”§ Setup ESLint
      run: |
        if [ ! -f .eslintrc.js ] && [ ! -f .eslintrc.json ] && [ ! -f .eslintrc ]; then
          npx eslint --init --quiet --yes \
            --eslintrc \
            --no-typescript \
            --env browser,es2021,node \
            --ext .js,.jsx \
            --plugin react \
            --rule 'react/prop-types: off' \
            --rule 'react/react-in-jsx-scope: off'
        fi
    
    - name: ğŸ” Run ESLint
      run: npx eslint src/ --max-warnings=10 --format=compact || echo "âš ï¸  ESLint issues found"
    
    - name: ğŸ›¡ï¸ npm audit security
      run: npm audit --audit-level=high || echo "âš ï¸  High severity vulnerabilities found"