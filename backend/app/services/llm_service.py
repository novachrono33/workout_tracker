# backend/app/services/llm_service.py
import os
import json
import re
import logging
import httpx
from typing import Dict, Any
from datetime import datetime
from urllib.parse import urljoin
from dotenv import load_dotenv

load_dotenv('/app/.env')

logger = logging.getLogger(__name__)

class LLMService:
    """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Cloudflare Workers AI"""
    
    def __init__(self):
        # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        self.account_id = os.getenv("CLOUDFLARE_ACCOUNT_ID")
        self.api_token = os.getenv("CLOUDFLARE_API_TOKEN")
        self.model = "@hf/nousresearch/hermes-2-pro-mistral-7b"
        self.timeout = float(os.getenv("LLM_REQUEST_TIMEOUT", "120"))
        
        if not self.account_id or not self.api_token:
            logger.error("CLOUDFLARE_ACCOUNT_ID –∏ CLOUDFLARE_API_TOKEN –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!")
            raise ValueError("Cloudflare credentials are required")
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Cloudflare API
        self.base_url = f"https://api.cloudflare.com/client/v4/accounts/{self.account_id}/ai/run/"
        self.model_url = urljoin(self.base_url, self.model)
        
        self.headers = {
            "Authorization": f"Bearer {self.api_token}",
            "Content-Type": "application/json"
        }
        
        logger.info(f"‚úÖ LLMService –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è Cloudflare AI")
        logger.info(f"   –ú–æ–¥–µ–ª—å: {self.model}")
        logger.info(f"   Account ID: {self.account_id}")
    
    def _create_prompt(self, workout_data: Dict[str, Any]) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ —Å —É—á–µ—Ç–æ–º –∂–µ—Å—Ç–∫–∏—Ö –ø—Ä–∞–≤–∏–ª"""
        exercise_info = workout_data.get("exercise_info", {})
        recent_workouts = workout_data.get("recent_workouts", [])
        current_sets = workout_data.get("current_sets", [])
        user_profile = workout_data.get("user_profile", {})
        
        exercise_name = exercise_info.get('name', '–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ')
        muscle_group = exercise_info.get('muscle_group', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ')
        user_goal = user_profile.get('training_goal', '–≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è')
        
        logger.debug(f"–°–æ–∑–¥–∞—é –ø—Ä–æ–º–ø—Ç –¥–ª—è —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è: {exercise_name}, —Ü–µ–ª—å: {user_goal}")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–±–æ—á–∏–π –≤–µ—Å –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞
        working_weight = 0
        last_set_reps = 0
        last_set_rir = None
        
        if current_sets:
            last_set = current_sets[-1]
            working_weight = last_set.get('weight_kg', 0)
            last_set_reps = last_set.get('reps', 0)
            last_set_rir = last_set.get('rir')
        
        prompt = f"""–¢—ã - –æ–ø—ã—Ç–Ω—ã–π —Ñ–∏—Ç–Ω–µ—Å-—Ç—Ä–µ–Ω–µ—Ä. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–∂–µ –Ω–∞—á–∞—Ç—É—é —Å–µ—Ä–∏—é –ø–æ–¥—Ö–æ–¥–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ.

–ö–û–ù–¢–ï–ö–°–¢:
- –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ: {exercise_name} ({muscle_group})
- –¶–µ–ª—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏: {user_goal}
- –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–¥—Ö–æ–¥–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ: {len(current_sets)}
- –†–∞–±–æ—á–∏–π –≤–µ—Å (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∞): {working_weight}–∫–≥
- –ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–¥—Ö–æ–¥: {last_set_reps} –ø–æ–≤—Ç. {f"(RIR: {last_set_rir})" if last_set_rir is not None else ""}

–ê–ë–°–û–õ–Æ–¢–ù–´–ï –ü–†–ê–í–ò–õ–ê (–ù–ï –ù–ê–†–£–®–ê–¢–¨):

1. –†–ï–ñ–ò–ú –†–ê–ë–û–¢–´:
   - –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –≤ —Ä–µ–∂–∏–º–µ –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø —É–∂–µ –Ω–∞—á–∞—Ç–æ–π —Å–µ—Ä–∏–∏
   - –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥ - —Ä–∞–±–æ—á–∏–π –≤–µ—Å —É–∂–µ –≤—ã–±—Ä–∞–Ω
   - –ù–ï –ü–ï–†–ï–û–¶–ï–ù–ò–í–ê–ô –∏ –Ω–µ –∏–∑–º–µ–Ω—è–π —Ä–∞–±–æ—á–∏–π –≤–µ—Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ

2. –§–ò–ö–°–ê–¶–ò–Ø –†–ê–ë–û–ß–ï–ì–û –í–ï–°–ê:
   - –í–µ—Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ - —ç—Ç–æ —Ä–∞–±–æ—á–∏–π –≤–µ—Å —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏
   - –ù–ò–ö–û–ì–î–ê –Ω–µ —Å–Ω–∏–∂–∞–π –≤–µ—Å –Ω–∏–∂–µ —Ä–∞–±–æ—á–µ–≥–æ –≤–µ—Å–∞
   - –†–∞–±–æ—á–∏–π –≤–µ—Å - —ç—Ç–æ —è–∫–æ—Ä—å, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–ª—å–∑—è —Å–º–µ—â–∞—Ç—å –≤–Ω–∏–∑
   - –ù–ò–ö–û–ì–î–ê –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –í–ï–° –ò–ó –ü–†–ò–ú–ï–†–û–í –ò–õ–ò –ò–°–¢–û–†–ò–ò; –¢–û–õ–¨–ö–û {working_weight}–∫–≥

3. –ó–ê–ü–†–ï–¢ –ù–ê –ò–ó–ú–ï–ù–ï–ù–ò–ï –í–ï–°–ê –í–ù–£–¢–†–ò –¢–†–ï–ù–ò–†–û–í–ö–ò:
   - –í —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –≤–µ—Å –ù–ò–ö–û–ì–î–ê –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è
   - –†–∞–±–æ—á–∏–π –≤–µ—Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω –Ω–∏ –≤ –∫–∞–∫—É—é —Å—Ç–æ—Ä–æ–Ω—É
   - –ò–ì–ù–û–†–ò–†–£–ô –õ–Æ–ë–´–ï –í–ï–°–ê –ò–ó –ü–†–ò–ú–ï–†–û–í; –û–ù–ò –¢–û–õ–¨–ö–û –î–õ–Ø –ò–õ–õ–Æ–°–¢–†–ê–¶–ò–ò –õ–û–ì–ò–ö–ò

4. –í–ï–° –ö–ê–ö –ñ–ï–°–¢–ö–ò–ô –ò–ù–í–ê–†–ò–ê–ù–¢ –í –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
   - –ï—Å–ª–∏ —Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—à—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ (sets_array –Ω–µ –ø—É—Å—Ç), –∑–Ω–∞—á–µ–Ω–∏–µ weight_kg –î–û–õ–ñ–ù–û –±—ã—Ç—å –°–¢–†–û–ì–û –†–ê–í–ù–û {working_weight}
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª—é–±–æ–≥–æ –¥—Ä—É–≥–æ–≥–æ –≤–µ—Å–∞ (–≤—ã—à–µ –∏–ª–∏ –Ω–∏–∂–µ —Ä–∞–±–æ—á–µ–≥–æ) —è–≤–ª—è–µ—Ç—Å—è –û–®–ò–ë–ö–û–ô
   - –ù–ï –ö–û–ü–ò–†–£–ô –í–ï–° –ò–ó –ü–†–ò–ú–ï–†–û–í; –í–°–ï–ì–î–ê –ò–°–ü–û–õ–¨–ó–£–ô {working_weight}

5. –ó–ê–ü–†–ï–¢ –ù–ê –ü–û–ò–°–ö ¬´–ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–û–ì–û –í–ï–°–ê¬ª:
   - –¢—ã –ù–ï –ò–ú–ï–ï–®–¨ –ü–†–ê–í–ê –ø–æ–¥–±–∏—Ä–∞—Ç—å –∏–Ω–æ–π –≤–µ—Å –¥–ª—è ¬´–ª—É—á—à–µ–π –ª–æ–≥–∏–∫–∏¬ª, ¬´–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞¬ª –∏–ª–∏ ¬´–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è¬ª
   - –í —Ä–∞–º–∫–∞—Ö —Ç–µ–∫—É—â–µ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¢–û–õ–¨–ö–û –û–î–ò–ù –¥–æ–ø—É—Å—Ç–∏–º—ã–π –≤–µ—Å ‚Äî {working_weight}
   - –ï—Å–ª–∏ —Å —ç—Ç–∏–º –≤–µ—Å–æ–º –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥, —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ó–ê–í–ï–†–®–ê–ï–¢–°–Ø (–ø—É—Å—Ç–æ–π sets_array)
   - –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –ß–ò–°–õ–ê –ò–ó –ü–†–ò–ú–ï–†–û–í –î–õ–Ø –í–ï–°–ê

6. –°–í–Ø–ó–¨ RIR –ò –í–ï–°–ê:
   - –¶–µ–ª–µ–≤–æ–π RIR –≤—Å–µ–≥–¥–∞ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –≤–µ—Å–∞
   - –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–µ—Å–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–µ–Ω—è–µ—Ç –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—é RIR –∏ –¥–µ–ª–∞–µ—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ù–ï–ö–û–†–†–ï–ö–¢–ù–´–ú
   - –ü–æ—ç—Ç–æ–º—É –ª—é–±—ã–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è RIR –¥–æ–ø—É—Å—Ç–∏–º—ã –¢–û–õ–¨–ö–û –ø—Ä–∏ –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–º –≤–µ—Å–µ

7. –ï–î–ò–ù–´–ô –í–ï–° –í –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ü–û–î–•–û–î–ê–•:
   - –í—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å –û–î–ù–ò–ú –ò –¢–ï–ú –ñ–ï –≤–µ—Å–æ–º
   - –ó–∞–ø—Ä–µ—â–µ–Ω—ã –ø–∏—Ä–∞–º–∏–¥—ã, –ª–µ—Å–µ–Ω–∫–∏, –≤–æ–ª–Ω—ã
   - –õ–∏–Ω–µ–π–Ω–∞—è —Å—Ö–µ–º–∞: –æ–¥–∏–Ω –≤–µ—Å –¥–ª—è –≤—Å–µ—Ö

8. –ü–†–ò–ù–¶–ò–ü –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–ò –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ì–û –ü–û–î–•–û–î–ê:
   - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ù–ï –ò–ú–ï–ï–¢ –ü–†–ê–í–ê –±—ã—Ç—å –∏–¥–µ–Ω—Ç–∏—á–Ω—ã–º —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–º—É
   - –ï—Å–ª–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–π –ø–æ–¥—Ö–æ–¥ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ø–æ –≤–µ—Å—É, –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è–º –∏ RIR —Å –ª—é–±—ã–º —Ä–∞–Ω–µ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º –≤ —ç—Ç–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ - –æ–Ω –ù–ï–î–û–ü–£–°–¢–ò–ú

9. –£–°–õ–û–í–ù–û–°–¢–¨ –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–Ø –°–õ–ï–î–£–Æ–©–ï–ì–û –ü–û–î–•–û–î–ê:
   - –°–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ–≥–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç—è–∂–µ–ª–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª
   - –ï—Å–ª–∏ —Ç–∞–∫–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–ø—É—Å—Ç–æ–π sets_array) —è–≤–ª—è–µ—Ç—Å—è –ï–î–ò–ù–°–¢–í–ï–ù–ù–û –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

10. –ó–ê–ü–†–ï–¢ –ù–ê –†–û–°–¢ –ü–û–í–¢–û–†–ï–ù–ò–ô –ü–†–ò –§–ò–ö–°–ò–†–û–í–ê–ù–ù–û–ú –í–ï–°–ï:
    - –í —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–µ—Å–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –ù–ï –ú–û–ñ–ï–¢ —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–æ–¥—Ö–æ–¥–æ–º –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è RIR
    - –†–æ—Å—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–Ω–∏–∂–µ–Ω–∏–∏ –≤–µ—Å–∞, –∫–æ—Ç–æ—Ä–æ–µ –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ó–ê–ü–†–ï–©–ï–ù–û
    - –î–æ–ø—É—Å—Ç–∏–º—ã —Ç–æ–ª—å–∫–æ –†–ê–í–ù–´–ï –∏–ª–∏ –ú–ï–ù–¨–®–ò–ï –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º
    - –ñ–ï–°–¢–ö–ò–ô –ó–ê–ü–†–ï–¢: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π reps –±–æ–ª—å—à–µ, —á–µ–º –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –ø–æ–¥—Ö–æ–¥–µ. –≠—Ç–æ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ñ–∏–∑–∏–æ–ª–æ–≥–∏–∏ —É—Ç–æ–º–ª–µ–Ω–∏—è.
    - –ù–ï –ö–û–ü–ò–†–£–ô REPS –ò–ó –ü–†–ò–ú–ï–†–û–í; –†–ê–°–°–ß–ò–¢–´–í–ê–ô –ù–ê –û–°–ù–û–í–ï –¢–ï–ö–£–©–ò–• SETS

11. –ü–†–ê–í–ò–õ–û –ò–°–ß–ï–†–ü–ê–ù–ò–Ø –†–ê–ë–û–ß–ï–ì–û –í–ï–°–ê:
    - –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥ —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ü–µ–ª–µ–≤–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ RIR –¥–ª—è –¥–∞–Ω–Ω–æ–π —Ü–µ–ª–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –ò –ø—Ä–∏ —ç—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —Å–Ω–∏–∂–∞–ª–æ—Å—å –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –ø–æ–¥—Ö–æ–¥–∞–º–∏ - —Ç–µ–∫—É—â–∏–π —Ä–∞–±–æ—á–∏–π –≤–µ—Å —Å—á–∏—Ç–∞–µ—Ç—Å—è –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ß–ï–†–ü–ê–ù–ù–´–ú
    - –í —ç—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –ù–ï —è–≤–ª—è–µ—Ç—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –∏ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏–µ–º
    - –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

12. –ü–†–ò–û–†–ò–¢–ï–¢ –£–¢–û–ú–õ–ï–ù–ò–Ø –ù–ê–î –î–ò–ê–ü–ê–ó–û–ù–ê–ú–ò:
    - –î–∏–∞–ø–∞–∑–æ–Ω—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π - —ç—Ç–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä, –Ω–æ –ù–ï –ò–ú–ï–Æ–¢ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –Ω–∞–¥ –ª–æ–≥–∏–∫–æ–π —É—Ç–æ–º–ª–µ–Ω–∏—è
    - –ï—Å–ª–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–æ–ª–µ–µ —Ç—è–∂—ë–ª–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—ã–π—Ç–∏ –Ω–∏–∂–µ –≤–µ—Ä—Ö–Ω–µ–π –≥—Ä–∞–Ω–∏—Ü—ã –¥–∏–∞–ø–∞–∑–æ–Ω–∞ - —ç—Ç–æ –î–û–ü–£–°–¢–ò–ú–û –∏ –ü–†–ï–î–ü–û–ß–¢–ò–¢–ï–õ–¨–ù–û, —á–µ–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–µ—Ç–∞
    - –ù–æ –µ—Å–ª–∏ reps —É–∂–µ –Ω–∏–∑–∫–∏–µ –∏ RIR –≤ —Ü–µ–ª–∏, –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å.

13. –ü–†–ò–ù–¶–ò–ü –ú–û–ù–û–¢–û–ù–ù–û–ì–û –£–¢–û–ú–õ–ï–ù–ò–Ø:
    - –ö–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ —Ç–æ–ª—å–∫–æ —Ç—è–∂–µ–ª–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–æ, –Ω–æ –∏ –ù–ï –ú–û–ñ–ï–¢ –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—Ç—å—Å—è –ª–µ–≥—á–µ –ø–æ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    - –ù–ï–î–û–ü–£–°–¢–ò–ú–´ —Å–∏—Ç—É–∞—Ü–∏–∏, –ø—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Å–∞ –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É–µ—Ç—Å—è —Ä–æ—Å—Ç–æ–º RIR –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, —á—Ç–æ —Å—É–±—ä–µ–∫—Ç–∏–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç—Å—è

14. –ó–ê–í–ï–†–®–ï–ù–ò–ï –¢–†–ï–ù–ò–†–û–í–ö–ò –ö–ê–ö –í–ê–õ–ò–î–ù–´–ô –ò–°–•–û–î:
    - –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ä–∞–±–æ—á–∏–π –≤–µ—Å –¥–æ—Å—Ç–∏–≥ —Ü–µ–ª–µ–≤–æ–≥–æ RIR –∏ –¥–∞–ª—å–Ω–µ–π—à–µ–µ —É—Å–ª–æ–∂–Ω–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∑–∞ —Å—á—ë—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª - —Ç—ã –û–ë–Ø–ó–ê–ù –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ë–ï–ó –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Ö–æ–¥–æ–≤
    - –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ —è–≤–ª—è–µ—Ç—Å—è –ö–û–†–†–ï–ö–¢–ù–´–ú –∏ –ü–†–ï–î–ü–û–ß–¢–ò–¢–ï–õ–¨–ù–´–ú —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º

15. –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –£–°–õ–û–í–ò–ï –ü–†–ò –ù–ï–í–û–ó–ú–û–ñ–ù–û–°–¢–ò –ü–†–û–ì–†–ï–°–°–ò–ò:
    - –ï—Å–ª–∏ –ù–ò –û–î–ù–û –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (reps, RIR) –Ω–µ –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥ —Ç—è–∂–µ–ª–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è —Ñ–∏–∑–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –ª–æ–≥–∏–∫–∏ - —Ç—ã –û–ë–Ø–ó–ê–ù –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –∏ –≤–µ—Ä–Ω—É—Ç—å –ü–£–°–¢–û–ô —Å–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–æ–≤
    - –ü–æ–ø—ã—Ç–∫–∏ "–Ω–∞–π—Ç–∏ –≤–∞—Ä–∏–∞–Ω—Ç" –≤ —Ç–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –û–®–ò–ë–ö–û–ô
    - –í —Ç–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤ –ó–ê–ü–†–ï–©–ï–ù–û
    - –ï—Å–ª–∏ reps –Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–Ω–∏–∂–µ–Ω—ã –¥–∞–ª—å—à–µ –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–∂–µ –Ω–∏–∑–∫–∏–µ), –≤–æ–∑–≤—Ä–∞—â–∞–π –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤.

16. –†–ê–ó–î–ï–õ–ï–ù–ò–ï –†–û–õ–ï–ô:
    - –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å –¢–ï–ö–£–©–£–Æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
    - –ù–ï –ø–ª–∞–Ω–∏—Ä—É–π –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é
    - –ù–ï –∑–∞–∫–ª–∞–¥—ã–≤–∞–π –∞–¥–∞–ø—Ç–∞—Ü–∏—é –Ω–∞–ø–µ—Ä—ë–¥
    - –ù–ï —Ä–µ—à–∞–π –∑–∞–¥–∞—á–∏ –±—É–¥—É—â–∏—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫

17. –û–ë–†–ê–ë–û–¢–ö–ê –û–î–ù–û–ì–û –ü–û–î–•–û–î–ê:
    - –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ–¥—Ö–æ–¥ - –æ–Ω —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä–∞–±–æ—á–∏–º —Å–µ—Ç–æ–º
    - –ü—Ä–æ–¥–æ–ª–∂–∞–π —ç—Ç–æ—Ç —Å–µ—Ç, –Ω–µ –∑–∞–º–µ–Ω—è–π –∏ –Ω–µ –ø–µ—Ä–µ–æ—Ü–µ–Ω–∏–≤–∞–π

18. –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ó–ê–ü–†–ï–¢ –ù–ê "–ü–ï–†–ï–û–¶–ï–ù–ö–£":
    - –ù–ï "—É–ª—É—á—à–∞–π" —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –ø–æ–¥–±–æ—Ä–æ–º "–ª–æ–≥–∏—á–Ω–æ–≥–æ" –≤–µ—Å–∞
    - –ù–ï –ø—Ä–µ–¥–ª–∞–≥–∞–π "–±–µ–∑–æ–ø–∞—Å–Ω—ã–π" –∏–ª–∏ "–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π" –≤–µ—Å
    - –°—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π –ø—Ä–µ–µ–º—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å —Ç–µ–∫—É—â–∏–º —Ä–∞–±–æ—á–∏–º –≤–µ—Å–æ–º

–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï –ü–†–ê–í–ò–õ–û:
- –ö–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç—è–∂–µ–ª–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ, –∏–Ω–∞—á–µ –µ–≥–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
- –ï—Å–ª–∏ –º–æ–¥–µ–ª—å —Å–æ–º–Ω–µ–≤–∞–µ—Ç—Å—è ‚Äî –æ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –º–æ–ª—á–∞—Ç—å, –∞ –Ω–µ —Ñ–∞–Ω—Ç–∞–∑–∏—Ä–æ–≤–∞—Ç—å.
- –ò–Ω–æ–≥–¥–∞ –õ–£–ß–®–ò–ô —Å–µ—Ç ‚Äî —ç—Ç–æ –û–¢–°–£–¢–°–¢–í–ò–ï —Å–ª–µ–¥—É—é—â–µ–≥–æ.
- –ù–µ—Ç —Ñ–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è ‚Äú–¥–∞–ª—å—à–µ –Ω–µ–ª—å–∑—è‚Äù. –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å —Ç—è–∂–µ–ª–µ–µ - –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤.
- –ñ–µ—Å—Ç–∫–æ –∑–∞–ø—Ä–µ—Ç–∏ —Ä–æ—Å—Ç reps: reps —Å–ª–µ–¥—É—é—â–µ–≥–æ <= reps –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ, —Å—Ç—Ä–æ–≥–æ.
- –ù–ò–ö–û–ì–î–ê –ù–ï –ö–û–ü–ò–†–£–ô –ó–ù–ê–ß–ï–ù–ò–Ø –ò–ó –ü–†–ò–ú–ï–†–û–í; –û–ù–ò –¢–û–õ–¨–ö–û –î–õ–Ø –ü–û–ù–ò–ú–ê–ù–ò–Ø –õ–û–ì–ò–ö–ò, –ù–ï –î–õ–Ø –ö–û–ü–ò–†–û–í–ê–ù–ò–Ø –ß–ò–°–ï–õ.

–§–û–†–ú–£–õ–ê –î–ï–ô–°–¢–í–ò–ô:
1. –†–∞–±–æ—á–∏–π –≤–µ—Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –Ω–∞ –≤—Å—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É: –≤—Å–µ–≥–¥–∞ {working_weight}
2. –°–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ–≥–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç—è–∂–µ–ª–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
3. –¢—è–∂–µ–ª–µ–µ = —Å–Ω–∏–∂–µ–Ω–∏–µ RIR –ò/–ò–õ–ò —Å–Ω–∏–∂–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–æ–≤
4. –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å —Ç—è–∂–µ–ª–µ–µ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
5. –í–µ—Å –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –í–°–ï–ì–î–ê —Ä–∞–≤–µ–Ω {working_weight}
6. reps —Å–ª–µ–¥—É—é—â–µ–≥–æ <= reps –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ, –±–µ–∑ –∏—Å–∫–ª—é—á–µ–Ω–∏–π.
7. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —á–∏—Å–ª–∞ –∏–∑ –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–ª—è –≤–µ—Å–∞, reps –∏–ª–∏ RIR; —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–π –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

–ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ï –î–ê–ù–ù–´–ï:"""

        if recent_workouts:
            logger.debug(f"–î–æ–±–∞–≤–ª—è—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑ {len(recent_workouts)} –ø—Ä–æ—à–ª—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫")
            for i, workout in enumerate(recent_workouts):
                prompt += f"\n\n–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ {i+1} –Ω–∞–∑–∞–¥:"
                sets = workout.get('sets', [])
                if sets:
                    for set_data in sets:
                        weight = set_data.get('weight_kg', 0)
                        reps = set_data.get('reps', 0)
                        rir = set_data.get('rir')
                        prompt += f"\n‚Ä¢ {weight}–∫–≥ √ó {reps} –ø–æ–≤—Ç." + (f" (RIR: {rir})" if rir is not None else "")
        else:
            prompt += "\n–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç."
            logger.debug("–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç")

        prompt += f"\n\n–¢–ï–ö–£–©–ê–Ø –¢–†–ï–ù–ò–†–û–í–ö–ê:"
        
        if current_sets:
            logger.debug(f"–î–æ–±–∞–≤–ª—è—é {len(current_sets)} —Ç–µ–∫—É—â–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤")
            for i, set_data in enumerate(current_sets):
                weight = set_data.get('weight_kg', 0)
                reps = set_data.get('reps', 0)
                rir = set_data.get('rir')
                prompt += f"\n–ü–æ–¥—Ö–æ–¥ {set_data.get('set_number', i+1)}: {weight}–∫–≥ √ó {reps} –ø–æ–≤—Ç." + (f" (RIR: {rir})" if rir is not None else "")
        else:
            prompt += "\n–ü–æ–¥—Ö–æ–¥–æ–≤ –µ—â–µ –Ω–µ –±—ã–ª–æ."
            logger.debug("–¢–µ–∫—É—â–∏—Ö –ø–æ–¥—Ö–æ–¥–æ–≤ –Ω–µ—Ç")

        prompt += f"""

–¶–ï–õ–ï–í–´–ï –î–ò–ê–ü–ê–ó–û–ù–´ –ü–û–í–¢–û–†–ï–ù–ò–ô (–¥–ª—è —Å–ø—Ä–∞–≤–∫–∏):
‚Ä¢ –ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è: 6-12 –ø–æ–≤—Ç. (–æ—Å–Ω–æ–≤–Ω–æ–π 8-12)
‚Ä¢ –°–∏–ª–∞: 1-6 –ø–æ–≤—Ç. (–æ—Å–Ω–æ–≤–Ω–æ–π 3-6)
‚Ä¢ –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: 12-30 –ø–æ–≤—Ç.

–¶–ï–õ–ï–í–´–ï –ó–ù–ê–ß–ï–ù–ò–Ø RIR (0-3, —à–∞–≥ 0.5):
‚Ä¢ –ì–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è: RIR 2-1 –≤ —Ä–∞–±–æ—á–∏—Ö –ø–æ–¥—Ö–æ–¥–∞—Ö
‚Ä¢ –°–∏–ª–∞: RIR 3-2
‚Ä¢ –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: RIR 3-2

–ö–û–õ–ò–ß–ï–°–¢–í–û –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ü–û–î–•–û–î–û–í:
‚Ä¢ –ë–∞–∑–æ–≤—ã–µ: 1-3 –ø–æ–¥—Ö–æ–¥–∞
‚Ä¢ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ: 1-2 –ø–æ–¥—Ö–æ–¥–∞
‚Ä¢ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –µ—Å–ª–∏ RIR ‚â§ 1.5 –∏–ª–∏ —É—Å—Ç–∞–ª–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞—è
‚Ä¢ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –µ—Å–ª–∏ –≤–µ—Å —Å–ª–∏—à–∫–æ–º —Ç—è–∂–µ–ª—ã–π
‚Ä¢ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –µ—Å–ª–∏ –ù–ï–í–û–ó–ú–û–ñ–ù–û —Å–¥–µ–ª–∞—Ç—å –ø–æ–¥—Ö–æ–¥ —Ç—è–∂–µ–ª–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
‚Ä¢ –ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å –µ—Å–ª–∏ –≤–µ—Å –ò–°–ß–ï–†–ü–ê–ù (RIR —Ü–µ–ª–µ–≤–æ–π + reps —Å–Ω–∏–∂–∞–ª–∏—Å—å)

–ü–†–ò–ú–ï–†–´ –ö–û–†–†–ï–ö–¢–ù–´–• –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ô (–¢–û–õ–¨–ö–û –î–õ–Ø –ò–õ–õ–Æ–°–¢–†–ê–¶–ò–ò –õ–û–ì–ò–ö–ò, –ù–ï –ö–û–ü–ò–†–£–ô –ß–ò–°–õ–ê):
1. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 12 –ø–æ–≤—Ç. √ó RIR 2
   –î–æ–ø—É—Å—Ç–∏–º–æ: –í–ï–° √ó 10 –ø–æ–≤—Ç. √ó RIR 1.5 ‚Üí –í–ï–° √ó 9 –ø–æ–≤—Ç. √ó RIR 1
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: –¥—Ä—É–≥–æ–π –≤–µ—Å, –í–ï–° √ó 12 –ø–æ–≤—Ç. √ó RIR 2

2. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 6 –ø–æ–≤—Ç. √ó RIR 3 (—Å–∏–ª–∞)
   –î–æ–ø—É—Å—Ç–∏–º–æ: –í–ï–° √ó 5 –ø–æ–≤—Ç. √ó RIR 2 ‚Üí –í–ï–° √ó 4 –ø–æ–≤—Ç. √ó RIR 1.5
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: –¥—Ä—É–≥–æ–π –≤–µ—Å, –í–ï–° √ó 6 –ø–æ–≤—Ç. √ó RIR 3

3. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 8 –ø–æ–≤—Ç. √ó RIR 1 (–≥–∏–ø–µ—Ä—Ç—Ä–æ—Ñ–∏—è, reps —Å–Ω–∏–∂–∞–ª–∏—Å—å —Ä–∞–Ω–µ–µ)
   –†–ï–ó–£–õ–¨–¢–ê–¢: –ø—É—Å—Ç–æ–π sets_array (–≤–µ—Å –∏—Å—á–µ—Ä–ø–∞–Ω)

4. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 10 –ø–æ–≤—Ç. √ó RIR 2
   –†–ï–ó–£–õ–¨–¢–ê–¢: –ø—É—Å—Ç–æ–π sets_array (–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç—è–∂–µ–ª–µ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Å–∞)

5. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 15 –ø–æ–≤—Ç. √ó RIR 2
   –î–æ–ø—É—Å—Ç–∏–º–æ: –í–ï–° √ó 12 –ø–æ–≤—Ç. √ó RIR 1.5
   –î–æ–ø—É—Å—Ç–∏–º–æ: –ø—É—Å—Ç–æ–π sets_array (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–±–æ—Ä –ø—Ä–∏ —Å–æ–º–Ω–µ–Ω–∏–∏)
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –≤–µ—Å

6. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 15 –ø–æ–≤—Ç. √ó RIR 2
   –î–æ–ø—É—Å—Ç–∏–º–æ: –í–ï–° √ó 10 –ø–æ–≤—Ç. √ó RIR 1.5
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: –í–ï–° √ó 15 –ø–æ–≤—Ç. √ó RIR 2 –∏–ª–∏ –±–æ–ª—å—à–µ reps

7. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 15 –ø–æ–≤—Ç. √ó RIR 2 –∏ –í–ï–° √ó 12 –ø–æ–≤—Ç. √ó RIR 2
   –î–æ–ø—É—Å—Ç–∏–º–æ: –í–ï–° √ó 10 –ø–æ–≤—Ç. √ó RIR 1.5
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: —É–≤–µ–ª–∏—á–µ–Ω–∏–µ reps

8. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 15 –ø–æ–≤—Ç. √ó RIR 2 –∏ –í–ï–° √ó 14 –ø–æ–≤—Ç. √ó RIR 2
   –î–æ–ø—É—Å—Ç–∏–º–æ: –í–ï–° √ó 10 –ø–æ–≤—Ç. √ó RIR 1.5
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: reps >14

9. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 8 –ø–æ–≤—Ç. √ó RIR 2
   –î–æ–ø—É—Å—Ç–∏–º–æ: –í–ï–° √ó 7 –ø–æ–≤—Ç. √ó RIR 1.5 –∏–ª–∏ –ø—É—Å—Ç–æ–π (–µ—Å–ª–∏ –∏—Å—á–µ—Ä–ø–∞–Ω)
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: –í–ï–° √ó 10 –ø–æ–≤—Ç. √ó RIR 1.5 (—Ä–æ—Å—Ç reps –∑–∞–ø—Ä–µ—â–µ–Ω)

10. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: –í–ï–° √ó 8 –ø–æ–≤—Ç. √ó RIR 1.5 –∏ –í–ï–° √ó 7 –ø–æ–≤—Ç. √ó RIR 1.5
    –î–æ–ø—É—Å—Ç–∏–º–æ: –ø—É—Å—Ç–æ–π sets_array (–≤–µ—Å –∏—Å—á–µ—Ä–ø–∞–Ω, reps —Å–Ω–∏–∂–∞–ª–∏—Å—å)
    –ù–ï–î–û–ü–£–°–¢–ò–ú–û: –í–ï–° √ó 10 –ø–æ–≤—Ç. √ó RIR 1.5 –∏–ª–∏ –ª—é–±–æ–π —Ä–æ—Å—Ç reps

–ù–ï–î–û–ü–£–°–¢–ò–ú–´–ï –ü–†–ò–ú–ï–†–´ (–ù–ò–ö–û–ì–î–ê –ù–ï –î–ï–õ–ê–ô –¢–ê–ö):
1. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: 32 √ó 8 √ó 1.5 –∏ 32 √ó 7 √ó 1.5
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: 22 √ó 12 √ó 1.5 (–Ω–µ–≤–µ—Ä–Ω—ã–π –≤–µ—Å, —Ä–æ—Å—Ç reps)

2. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: 18 √ó 10 √ó 2
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: 22 √ó 12 √ó 1.5 (–Ω–µ–≤–µ—Ä–Ω—ã–π –≤–µ—Å, —Ä–æ—Å—Ç reps)

3. –í—ã–ø–æ–ª–Ω–µ–Ω–æ: 18 √ó 10 √ó 2 –∏ 18 √ó 9 √ó 2
   –ù–ï–î–û–ü–£–°–¢–ò–ú–û: 22 √ó 12 √ó 1.5 (–Ω–µ–≤–µ—Ä–Ω—ã–π –≤–µ—Å, —Ä–æ—Å—Ç reps)

–í–û–ó–í–†–ê–©–ê–ô –û–¢–í–ï–¢ –í –§–û–†–ú–ê–¢–ï JSON:

{{
    "recommendations": [
        {{
            "exercise_name": "{exercise_name}",
            "sets_array": [
                {{
                    "set_number": —Å–ª–µ–¥—É—é—â–∏–π_–Ω–æ–º–µ—Ä_–ø–æ–¥—Ö–æ–¥–∞,
                    "weight_kg": {working_weight}.0,  <!-- –í–ï–° –í–°–ï–ì–î–ê {working_weight}! –ù–ï –ò–ó –ü–†–ò–ú–ï–†–û–í -->
                    "reps": —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ_–ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è,
                    "target_rir": —Ü–µ–ª–µ–≤–æ–π_RIR
                }}
            ]
        }}
    ]
}}

–í–ê–ñ–ù–û:
- –í–µ—Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –≤–æ –≤—Å–µ—Ö –ø–æ–¥—Ö–æ–¥–∞—Ö: —Å—Ç—Ä–æ–≥–æ {working_weight}
- –ù–µ –∫–æ–ø–∏—Ä—É–π —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã
- –°–ª–µ–¥—É—é—â–∏–π –ø–æ–¥—Ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ–≥–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç—è–∂–µ–ª–µ–µ
- –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ö–æ–¥—ã, –≤–æ–∑–≤—Ä–∞—â–∞–π –ø—É—Å—Ç–æ–π sets_array
- –í–µ—Å –≤ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –í–°–ï–ì–î–ê —Å—Ç—Ä–æ–≥–æ —Ä–∞–≤–µ–Ω {working_weight}
- –ò–Ω–æ–≥–¥–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥—Ö–æ–¥–∞ - —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
- –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è - –≤–æ–∑–≤—Ä–∞—â–∞–π –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
- –¢–æ–ª—å–∫–æ —á–∏—Å—Ç—ã–π JSON, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
- –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –ß–ò–°–õ–ê –ò–ó –ü–†–ò–ú–ï–†–û–í –í –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
- reps –∏ target_rir –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä "reps": 10, "target_rir": 1.5"""
        
        logger.debug("–ü—Ä–æ–º–ø—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ")
        return prompt
    
    async def get_training_recommendation(self, workout_data: Dict[str, Any]) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é –ø–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ –æ—Ç Cloudflare Workers AI
        """
        
        logger.info("üîÑ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ—Ç Cloudflare AI")
        
        try:
            # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–ø—Ç
            user_prompt = self._create_prompt(workout_data)
            
            logger.info(f"üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –∫ Cloudflare AI: {self.model}")
            logger.debug(f"–î–ª–∏–Ω–∞ –ø—Ä–æ–º–ø—Ç–∞: {len(user_prompt)} —Å–∏–º–≤–æ–ª–æ–≤")
            
            # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è Cloudflare API
            payload = {
                "prompt": user_prompt,
                "max_tokens": 512,
                "temperature": 0.1,
                "stream": False
            }
            
            # –í—ã–∑—ã–≤–∞–µ–º Cloudflare API
            start_time = datetime.now()
            
            async with httpx.AsyncClient(timeout=self.timeout) as client:
                response = await client.post(
                    self.model_url,
                    headers=self.headers,
                    json=payload
                )
            
            end_time = datetime.now()
            duration = (end_time - start_time).total_seconds()
            
            logger.info(f"‚úÖ –û—Ç–≤–µ—Ç –æ—Ç Cloudflare AI –ø–æ–ª—É—á–µ–Ω –∑–∞ {duration:.2f} —Å–µ–∫—É–Ω–¥")
            
            if response.status_code != 200:
                error_msg = f"Cloudflare API error: {response.status_code} - {response.text}"
                logger.error(f"‚ùå {error_msg}")
                raise Exception(error_msg)
            
            result = response.json()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å
            if not result.get("success", False):
                error_msg = f"Cloudflare API error: {result.get('errors', [{}])[0].get('message', 'Unknown error')}"
                logger.error(f"‚ùå {error_msg}")
                raise Exception(error_msg)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            content = ""
            if "result" in result and isinstance(result["result"], dict):
                content = result["result"].get("response", "")
            else:
                content = str(result)
            
            logger.debug(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Cloudflare AI: {content[:200]}...")
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞
            clean_json = self._extract_json_from_response(content)
            
            logger.debug("–ü—ã—Ç–∞—é—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON –æ—Ç–≤–µ—Ç")
            
            try:
                recommendations = json.loads(clean_json)
                logger.info("‚úÖ JSON —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω")
            except json.JSONDecodeError as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}")
                logger.error(f"–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: {content[:500]}")
                # –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –≤ —Ç–µ–∫—Å—Ç–µ
                json_match = re.search(r'\{.*\}', content, re.DOTALL)
                if json_match:
                    logger.warning("üîÑ –ü—ã—Ç–∞—é—Å—å –∏–∑–≤–ª–µ—á—å JSON –∏–∑ —Ç–µ–∫—Å—Ç–∞")
                    recommendations = json.loads(json_match.group())
                else:
                    raise Exception(f"–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç Cloudflare AI: {e}")
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã –≤ sets_array
            if "recommendations" in recommendations:
                for rec in recommendations["recommendations"]:
                    if "sets_array" in rec:
                        for set_data in rec["sets_array"]:
                            if "weight_kg" in set_data:
                                set_data["weight_kg"] = float(set_data["weight_kg"])
                            if "reps" in set_data:
                                set_data["reps"] = int(set_data["reps"])
                            if "target_rir" in set_data:
                                set_data["target_rir"] = float(set_data["target_rir"])
                            if "set_number" in set_data:
                                set_data["set_number"] = int(set_data["set_number"])
            
            # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            recommendations["llm_metadata"] = {
                "model": self.model,
                "provider": "cloudflare",
                "timestamp": datetime.now().isoformat(),
                "response_time_seconds": duration
            }
            
            logger.info(f"‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ —á–µ—Ä–µ–∑ Cloudflare AI")
            return recommendations
            
        except Exception as e:
            logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ Cloudflare AI: {str(e)}", exc_info=True)
            raise
    
    def _extract_json_from_response(self, text: str) -> str:
        """–ò–∑–≤–ª–µ–∫–∞–µ—Ç JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞"""
        if not text:
            logger.warning("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç Cloudflare AI")
            return "{}"
        
        logger.debug("–ò–∑–≤–ª–µ–∫–∞—é JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞")
        
        # –£–±–∏—Ä–∞–µ–º markdown
        json_match = re.search(r'```json\s*(.*?)\s*```', text, re.DOTALL)
        if json_match:
            logger.debug("–ù–∞–π–¥–µ–Ω JSON –≤ markdown –±–ª–æ–∫–∞—Ö")
            text = json_match.group(1).strip()
        else:
            # –ò—â–µ–º JSON –≤ —Ç–µ–∫—Å—Ç–µ
            json_match = re.search(r'(\{.*\})', text, re.DOTALL)
            if json_match:
                logger.debug("–ù–∞–π–¥–µ–Ω JSON –≤ —Ç–µ–∫—Å—Ç–µ")
                text = json_match.group(1).strip()
            else:
                logger.warning("JSON –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ, –≤–æ–∑–≤—Ä–∞—â–∞—é –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç")
        
        # –£–±–∏—Ä–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        text = re.sub(r'//.*', '', text)
        text = re.sub(r'/\*.*?\*/', '', text, flags=re.DOTALL)
        
        logger.debug(f"–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π JSON: {text[:100]}...")
        return text.strip()